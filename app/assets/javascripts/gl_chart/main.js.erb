
var scene, camera, renderer, clock, controls, scale, stats, gui;
var gui_params;
var stars, constellation_lines;
function init() {

    console.log(vector3ToLatLong(new THREE.Vector3(0,0,1)));

    clock = new THREE.Clock();

    camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.z = 50;

    scene = new THREE.Scene();


    renderer = new THREE.WebGLRenderer({ antialias: true, precision: "lowp", alpha: false, premultipliedAlpha: false, stencil: false });
    renderer.setSize( window.innerWidth , window.innerHeight );



    $('#chart').append( renderer.domElement );

    stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';
    $('#chart').append( stats.domElement );
    //

    window.addEventListener( 'resize', onWindowResize, false );

    init_controller();
    init_elements();
    init_events();
    init_gui();

}

function init_controller() {
    controls = new THREE.TrackballControls(camera, $('#chart')[0]);
    controls.noPan = true;
    controls.zoomSpeed = 3.0;
    //    controls.dynamicDampingFactor = 0.6;
}

function init_gui() {
    gui = new dat.GUI();

    gui_params = {
        mag: 4.5,
        constellations: true
    }

    gui.add(gui_params, 'mag').min(0.0).max(8.0).step(0.5)
        .onChange(function(mag) {
            if(stars != undefined)
                stars.updateLimitMag(gui_params.mag);
        });
    gui.add(gui_params, 'constellations')
        .onChange(function(value) {
            if(value)
                scene.add(constellation_lines);
            else
                scene.remove(constellation_lines);


        });



}

function onWindowResize() {

    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();

    renderer.setSize( window.innerWidth, window.innerHeight );

}

function init_elements() {
    init_stars();
    init_constellations();
}


function init_stars() {
    stars = new Stars();
    stars.generate_stars(addStarsCallback);
}

function addStarsCallback(sphere) {
    console.log("Added sphere");
    scene.add(sphere);
    //    renderer.render(scene, camera);

}

function init_constellations() {
    constellations = new Constellations();
    constellations.generate_constellations(addConstellationsCallback);

}

function addConstellationsCallback(lines) {
    console.log("Added constellation lines");
    constellation_lines = lines;
    scene.add(lines);


}

function init_events() {
    controls.addMouseCallback(updatePosition);

}

function updatePosition(dir) {
    //    console.log("UpdatePosition called");
    //    console.log(vector3ToLatLong(dir));
}



function animate() {

    requestAnimationFrame( animate );

    var delta = clock.getDelta();
    controls.update(delta);


    render();
    stats.update();

}

function render() {


    //    var time = Date.now() * 0.005;

    //    sphere.rotation.y = 0.02 * time;
    //    sphere.rotation.z = 0.02 * time;

    // for( var i = 0; i < attributes.size.value.length; i ++ ) {

    //     if ( i < vc1 )
    //         attributes.size.value[ i ] = 16 + 12 * Math.sin( 0.1 * i + time );


    // }

    //    attributes.size.needsUpdate = true;


    renderer.render(scene, camera);

}


init();
animate();
